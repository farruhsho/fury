# Fury Messenger - Architecture Diagrams

## System Architecture

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              FURY MESSENGER                                 │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                        PRESENTATION LAYER                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │  │
│  │  │  Pages   │  │ Widgets  │  │  BLoCs   │  │ Providers│            │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                       │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                          DOMAIN LAYER                                │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐                  │  │
│  │  │ Entities │  │ UseCases │  │ Repo Interfaces  │                  │  │
│  │  └──────────┘  └──────────┘  └──────────────────┘                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                       │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                           DATA LAYER                                 │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │  │
│  │  │ Repos    │  │ Models   │  │ Remote DS│  │ Local DS │            │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                       │
└────────────────────────────────────┼───────────────────────────────────────┘
                                     │
                                     ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                           EXTERNAL SERVICES                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │Firebase Auth │  │  Firestore   │  │   Storage    │  │    WebRTC    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## Feature Module Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          FEATURE MODULE                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────────────────────────────────────────────────────────────┐ │
│   │  presentation/                                                    │ │
│   │  ├── pages/          # Full-screen views                         │ │
│   │  ├── widgets/        # Reusable UI components                    │ │
│   │  └── bloc/           # State management                          │ │
│   │      ├── *_bloc.dart                                             │ │
│   │      ├── *_event.dart                                            │ │
│   │      └── *_state.dart                                            │ │
│   └──────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│   ┌──────────────────────────────────────────────────────────────────┐ │
│   │  domain/                                                          │ │
│   │  ├── entities/       # Business objects                          │ │
│   │  ├── repositories/   # Abstract interfaces                       │ │
│   │  └── usecases/       # Business logic                            │ │
│   └──────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│   ┌──────────────────────────────────────────────────────────────────┐ │
│   │  data/                                                            │ │
│   │  ├── datasources/    # API/DB access                             │ │
│   │  ├── models/         # Data transfer objects                     │ │
│   │  └── repositories/   # Implementations                           │ │
│   └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Message Flow

```
┌──────────┐         ┌──────────┐         ┌──────────┐         ┌──────────┐
│   User   │         │    UI    │         │   BLoC   │         │ UseCase  │
└────┬─────┘         └────┬─────┘         └────┬─────┘         └────┬─────┘
     │                    │                    │                    │
     │  1. Type Message   │                    │                    │
     │───────────────────▶│                    │                    │
     │                    │                    │                    │
     │                    │  2. Dispatch Event │                    │
     │                    │───────────────────▶│                    │
     │                    │                    │                    │
     │                    │                    │  3. Call UseCase   │
     │                    │                    │───────────────────▶│
     │                    │                    │                    │
     │                    │                    │                    │
     │                    │                    │                    ▼
     │                    │                    │         ┌──────────────────┐
     │                    │                    │         │   Repository     │
     │                    │                    │         └────────┬─────────┘
     │                    │                    │                  │
     │                    │                    │                  │ 4. Encrypt
     │                    │                    │                  ▼
     │                    │                    │         ┌──────────────────┐
     │                    │                    │         │ EncryptionService│
     │                    │                    │         └────────┬─────────┘
     │                    │                    │                  │
     │                    │                    │                  │ 5. Store
     │                    │                    │                  ▼
     │                    │                    │         ┌──────────────────┐
     │                    │                    │         │    Firestore     │
     │                    │                    │         └────────┬─────────┘
     │                    │                    │                  │
     │                    │  6. Stream Update  │◀─────────────────┘
     │                    │◀───────────────────│                  
     │                    │                    │                  
     │  7. Show Message   │                    │                  
     │◀───────────────────│                    │                  
     │                    │                    │                  
```

---

## WebRTC Call Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                            CALL ESTABLISHMENT                             │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   CALLER                    FIRESTORE                      CALLEE        │
│   ┌─────┐                   ┌───────┐                      ┌─────┐      │
│   │     │                   │       │                      │     │      │
│   │  1. Create Offer        │       │                      │     │      │
│   │     │───────────────────▶       │                      │     │      │
│   │     │                   │       │                      │     │      │
│   │     │                   │  2. Notify ─────────────────▶│     │      │
│   │     │                   │       │                      │     │      │
│   │     │                   │       │◀──── 3. Accept ──────│     │      │
│   │     │                   │       │                      │     │      │
│   │     │                   │       │◀─── 4. Create Answer─│     │      │
│   │     │                   │       │                      │     │      │
│   │     │◀── 5. Get Answer──│       │                      │     │      │
│   │     │                   │       │                      │     │      │
│   │     │                   │       │                      │     │      │
│   │     │◀══════════ 6. ICE Candidate Exchange ═══════════▶│     │      │
│   │     │                   │       │                      │     │      │
│   │     │                   │       │                      │     │      │
│   │     │════════════════ 7. P2P MEDIA STREAM ════════════▶│     │      │
│   │     │                   │       │                      │     │      │
│   └─────┘                   └───────┘                      └─────┘      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Encryption Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         E2E ENCRYPTION FLOW                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────┐                         ┌─────────────────┐       │
│   │     SENDER      │                         │    RECIPIENT    │       │
│   └────────┬────────┘                         └────────┬────────┘       │
│            │                                           │                 │
│   ┌────────▼────────┐                         ┌────────▼────────┐       │
│   │  Generate Keys  │                         │  Generate Keys  │       │
│   │  - Identity Key │                         │  - Identity Key │       │
│   │  - Session Keys │                         │  - Session Keys │       │
│   └────────┬────────┘                         └────────┬────────┘       │
│            │                                           │                 │
│            │              ┌─────────┐                  │                 │
│            └──────────────▶FIRESTORE◀──────────────────┘                 │
│                           │  Keys   │                                    │
│                           └────┬────┘                                    │
│                                │                                         │
│   ┌────────────────────────────┼────────────────────────────┐           │
│   │                            ▼                            │           │
│   │   KEY EXCHANGE (X25519 Diffie-Hellman)                  │           │
│   │   ┌─────────────────────────────────────────────────┐   │           │
│   │   │  Shared Secret = X25519(privA, pubB)            │   │           │
│   │   │  Session Key = HKDF(shared_secret, salt, info)  │   │           │
│   │   └─────────────────────────────────────────────────┘   │           │
│   └─────────────────────────────────────────────────────────┘           │
│                                │                                         │
│   ┌────────────────────────────▼────────────────────────────┐           │
│   │  ENCRYPTION (AES-256-GCM)                               │           │
│   │  ┌─────────────────────────────────────────────────┐    │           │
│   │  │  Ciphertext = AES_GCM(key, nonce, plaintext)    │    │           │
│   │  │  + Authentication Tag (16 bytes)                 │    │           │
│   │  └─────────────────────────────────────────────────┘    │           │
│   └─────────────────────────────────────────────────────────┘           │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## BLoC State Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           BLOC PATTERN                                    │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│    ┌─────────┐        ┌─────────────────────────────┐        ┌────────┐ │
│    │  Event  │───────▶│           BLoC              │───────▶│ State  │ │
│    └─────────┘        │                             │        └────────┘ │
│                       │  ┌───────────────────────┐  │                   │
│                       │  │    Event Handler      │  │                   │
│                       │  │                       │  │                   │
│                       │  │  1. Receive Event     │  │                   │
│                       │  │  2. Call UseCase      │  │                   │
│                       │  │  3. Handle Result     │  │                   │
│                       │  │  4. Emit New State    │  │                   │
│                       │  └───────────────────────┘  │                   │
│                       │              │              │                   │
│                       │              ▼              │                   │
│                       │  ┌───────────────────────┐  │                   │
│                       │  │       UseCase         │  │                   │
│                       │  └───────────────────────┘  │                   │
│                       └─────────────────────────────┘                   │
│                                                                          │
│    Example States:                                                       │
│    ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│    │  Initial   │  │  Loading   │  │  Loaded    │  │   Error    │       │
│    └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Dependency Injection

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        DEPENDENCY INJECTION (GetIt)                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│    injection_container.dart                                              │
│    ┌────────────────────────────────────────────────────────────────┐   │
│    │                                                                │   │
│    │   // Singletons (one instance)                                 │   │
│    │   getIt.registerLazySingleton<FirebaseFirestore>(...)          │   │
│    │   getIt.registerLazySingleton<EncryptionService>(...)          │   │
│    │   getIt.registerLazySingleton<KeyExchangeManager>(...)         │   │
│    │                                                                │   │
│    │   // Factories (new instance each time)                        │   │
│    │   getIt.registerFactory<MessageBloc>(...)                      │   │
│    │   getIt.registerFactory<ChatBloc>(...)                         │   │
│    │   getIt.registerFactory<CallBloc>(...)                         │   │
│    │                                                                │   │
│    │   // Dependency Chain                                          │   │
│    │   UseCase → Repository → DataSource → External Service        │   │
│    │                                                                │   │
│    └────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Data Model Relationships

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         DATA MODEL DIAGRAM                                │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│    ┌─────────────────┐         ┌─────────────────┐                      │
│    │      User       │         │      Chat       │                      │
│    ├─────────────────┤         ├─────────────────┤                      │
│    │ id              │◀───────▶│ id              │                      │
│    │ email           │   1:N   │ participantIds  │                      │
│    │ displayName     │         │ type            │                      │
│    │ avatarUrl       │         │ lastMessage     │                      │
│    │ status          │         │ createdAt       │                      │
│    │ lastSeen        │         │ updatedAt       │                      │
│    └─────────────────┘         └────────┬────────┘                      │
│                                         │                                │
│                                         │ 1:N                            │
│                                         ▼                                │
│                                ┌─────────────────┐                      │
│                                │     Message     │                      │
│                                ├─────────────────┤                      │
│                                │ id              │                      │
│                                │ chatId          │                      │
│                                │ senderId        │                      │
│                                │ text            │                      │
│                                │ type            │                      │
│                                │ attachments     │                      │
│                                │ reactions       │                      │
│                                │ replyToId       │                      │
│                                │ createdAt       │                      │
│                                │ status          │                      │
│                                └─────────────────┘                      │
│                                                                          │
│    ┌─────────────────┐         ┌─────────────────┐                      │
│    │      Call       │         │   BroadcastList │                      │
│    ├─────────────────┤         ├─────────────────┤                      │
│    │ id              │         │ id              │                      │
│    │ callerId        │         │ name            │                      │
│    │ calleeId        │         │ recipientIds    │                      │
│    │ type            │         │ createdAt       │                      │
│    │ status          │         │ lastMessageAt   │                      │
│    │ offer           │         └─────────────────┘                      │
│    │ answer          │                                                   │
│    │ startedAt       │                                                   │
│    │ endedAt         │                                                   │
│    └─────────────────┘                                                   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

*Generated: December 2024*
